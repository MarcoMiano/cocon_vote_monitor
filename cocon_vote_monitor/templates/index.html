<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Voting Results</title>
      <link rel="stylesheet" href="/static/main.css">
  </head>
  <body>
    <header>
      <p id="datetime">{{ datetime }}</p>
      <h1 id="meeting-title"></h1>
      <h2 id="agenda-title"></h2>
      <button id="print-btn" onclick="window.print()">Print</button>
    </header>

    <!-- JS will fill this -->
    <main id="votes"></main>

    <footer>
      <div class="row">
        <div class="vote footer yes">
          <div class="vote-result footer"></div>
          <div class="vote-label  footer">YES</div>
          <div class="vote-count footer"></div>
        </div>
        <div class="vote footer abst">
          <div class="vote-result footer"></div>
          <div class="vote-label  footer">ABST</div>
          <div class="vote-count footer"></div>
        </div>
        <div class="vote footer no">
          <div class="vote-result footer"></div>
          <div class="vote-label  footer">NO</div>
          <div class="vote-count footer"></div>
        </div>
      </div>
    </footer>
    <script>
      const main      = document.getElementById('votes');
      const meetingEl = document.getElementById('meeting-title');
      const agendaEl  = document.getElementById('agenda-title');
      const dateEl    = document.getElementById('datetime');
      const footerEl  = document.querySelector('footer');
      const yesCnt = document.querySelector('.vote.footer.yes  .vote-count');
      const abtCnt = document.querySelector('.vote.footer.abst .vote-count');
      const noCnt  = document.querySelector('.vote.footer.no   .vote-count');

      function buildColumns(columns = []) {
        const frag = document.createDocumentFragment();

        for (const col of columns) {
          const colDiv = document.createElement('div');
          colDiv.className = 'column';

          for (const [delegate, result] of col) {          // â† pair [name, YES/NO/ABST/""]
            const voteDiv  = document.createElement('div');
            voteDiv.className = 'vote ' + (result ?? '').toLowerCase();

            const resDiv   = document.createElement('div');
            resDiv.className = 'vote-result';
            resDiv.textContent = result;                 // delegate name

            const labDiv   = document.createElement('div');
            labDiv.className = 'vote-label';
            labDiv.textContent = delegate || '';             // YES / NO / ABST / ''

            voteDiv.append(resDiv, labDiv);
            colDiv.appendChild(voteDiv);
          }
          frag.appendChild(colDiv);
        }
        return frag;
      }

      function update(data) {
        meetingEl.textContent = data.meeting_title ?? '';
        agendaEl.textContent  = data.agenda_title ?? '';
        dateEl.textContent    = data.datetime ?? '';
        main.replaceChildren(buildColumns(data.columns));
        yesCnt.textContent = data.counts?.YES ?? 0;
        abtCnt.textContent = data.counts?.ABST ?? 0;
        noCnt.textContent  = data.counts?.NO ?? 0;
        footerEl.style.display = data.show_results ? 'flex' : 'none';
      }

      const ws = new WebSocket(`ws://${location.host}/ws`);
      ws.onmessage = evt => update(JSON.parse(evt.data));
    </script>
  </body>
</html>